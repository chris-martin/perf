<meta charset="utf-8"> <link rel="stylesheet" href="https://tonyday567.github.io/other/lhs.css"> <link href="https://fonts.googleapis.com/css?family=Inconsolata|Lora|Raleway" rel="stylesheet">
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<h1 id="perf"><a href="https://tonyday567.github.io/perf/index.html">perf</a></h1>
<p><a href="https://travis-ci.org/tonyday567/perf"><img src="https://travis-ci.org/tonyday567/perf.svg" alt="Build Status" /></a> <a href="https://hackage.haskell.org/package/perf"><img src="https://img.shields.io/hackage/v/perf.svg" alt="Hackage" /></a> <a href="http://stackage.org/lts/package/perf"><img src="https://www.stackage.org/package/perf/badge/lts" alt="lts" /></a> <a href="http://stackage.org/nightly/package/perf"><img src="https://www.stackage.org/package/perf/badge/nightly" alt="nightly" /></a></p>
<p><a href="https://github.com/tonyday567/perf">repo</a></p>
<p>If you want to make stuff very fast in haskell, you need to dig down below the criterion-style level of abstraction and start counting cycles using the <a href="https://en.wikipedia.org/wiki/Time_Stamp_Counter">rdtsc</a> register on x86.</p>
<p>This library is an experiment in measuring cycles (or ticks), and development of intuition about what is going on at the very fast level.</p>
<h1 id="examples">Examples</h1>
<p>The code for all results can be found in <a href="examples/examples.hs" class="uri">examples/examples.hs</a>.</p>
<h2 id="tick_">tick_</h2>
<pre><code>one tick_: 18 cycles
next 10: [20,18,18,18,20,20,18,18,20,18]
average over 1m: 20.46 cycles
99.999% perc: 408
99.9% perc: 55.90
99th perc:  31.08
40th perc:  18.82
[min, 10th, 20th, .. 90th, max]:
 12.00 17.09 17.66 18.24 18.82 19.56 20.36 21.42 23.24 24.37 3.448e4</code></pre>
<h2 id="tick">tick</h2>
<pre><code>sum to 10000.0
first measure: 1255634 cycles
average over next 1000: 98238.13 cycles
[min, 30th, median, 90th, 99th, max]:
 9.541e4 9.705e4 9.722e4 9.759e4 1.479e5 2.531e5</code></pre>
<h2 id="ticks">ticks</h2>
<pre><code>sum to 10000.0
Perf.ticks n f a                        8.49e4 cycles
Main.ticks n f a                        8.48e4 cycles
Perf.ticksIO n (pure $ f a)             9.84e4 cycles
Perf.qtick n f a                        8.49e4 cycles
Main.qtick n f a                        9.83e4 cycles
replicateM n (tick f a)                 8.48e4 cycles
replicateM&#39; n (tick f a)                8.47e4 cycles
replicateM n (tickIO (pure (f a)))      8.47e4 cycles
replicateM n (tick (app (f a)) ())      8.58e4 cycles
replicateM n (tick identity (f a))      8.48e4 cycles
replicateM n (tick (const (f a)) ())    8.48e4 cycles
(replicateM n . tick f) &lt;$&gt; [1,10,100,1000,10000]:  15.9 17.9 96.5 676 6.45e3
Perf.tickns n f [1,10,100,1000,10000]:  16.1 24.6 149 1.30e3 1.28e4</code></pre>
<h2 id="vector">vector</h2>
<pre><code>sum to 10000.0
boxed: 1.48e5
storable: 5.29e4
unboxed: 5.90e4</code></pre>
<h1 id="workflow">workflow</h1>
<pre><code>stack build --test --exec &quot;$(stack path --local-install-root)/bin/perf-examples&quot; --exec &quot;$(stack path --local-bin)/pandoc -f markdown -i other/header.md readme.md other/footer.md -t html -o index.html --filter pandoc-include --mathjax&quot; --file-watch</code></pre>
<p>solo experiments:</p>
<pre><code>stack exec &quot;ghc&quot; -- -O2 -rtsopts examples/summing.lhs
./examples/summing +RTS -s -RTS --runs 10000 --sumTo 1000 --chart --chartName other/sum1e3.svg --truncAt 4</code></pre>
<h1 id="references">references</h1>
<ul class="incremental">
<li><p><a href="https://www.cheatography.com/nash/cheat-sheets/ghc-and-rts-options/">rts cheat sheet</a></p></li>
<li><p><a href="http://ghc.readthedocs.io/en/8.0.2/sooner.html">ghc tips</a></p></li>
</ul>
<h2 id="time">time</h2>
<ul class="incremental">
<li><p><a href="http://neilmitchell.blogspot.co.uk/2014/01/optimising-haskell-for-tight-inner-loop.html">Optimising haskell for a tight inner loop</a></p></li>
<li><p><a href="http://stackoverflow.com/questions/3276240/tools-for-analyzing-performance-of-a-haskell-program/3276557#3276557">Tools for analysing performance</a></p></li>
<li><p><a href="https://donsbot.wordpress.com/2008/05/06/write-haskell-as-fast-as-c-exploiting-strictness-laziness-and-recursion/">Write haskell as fast as c</a></p></li>
<li><p><a href="http://stackoverflow.com/questions/6121146/reading-ghc-core">Reading ghc core</a></p></li>
</ul>
<h2 id="space">space</h2>
<ul class="incremental">
<li><p><a href="http://neilmitchell.blogspot.com.au/2013/02/chasing-space-leak-in-shake.html">Chasing space leaks in shake</a></p></li>
<li><p><a href="http://blog.ezyang.com/2011/05/space-leak-zoo/">Space leak zoo</a></p></li>
<li><p><a href="http://blog.ezyang.com/2011/05/anatomy-of-a-thunk-leak/">Anatomy of a thunk leak</a></p></li>
<li><p><a href="http://blog.ezyang.com/2011/05/an-insufficiently-lazy-map/">An insufficiently lazy map</a></p></li>
<li><p><a href="http://blog.ezyang.com/2011/06/pinpointing-space-leaks-in-big-programs/">Pinpointing space leaks in big programs</a></p></li>
</ul>
<h2 id="memoization">memoization</h2>
<p>http://okmij.org/ftp/Haskell/#memo-off</p>
<h2 id="cache-cycle-estimates">cache cycle estimates</h2>
<table>
<thead>
<tr class="header">
<th>Cache</th>
<th>Cycles</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>register</td>
<td>4 per cycle</td>
</tr>
<tr class="even">
<td>L1 Cache access</td>
<td>3-4 cycles</td>
</tr>
<tr class="odd">
<td>L2 Cache access</td>
<td>11-12 cycles</td>
</tr>
<tr class="even">
<td>L3 unified access</td>
<td>30 - 40</td>
</tr>
<tr class="odd">
<td>DRAM hit</td>
<td>195 cycles</td>
</tr>
<tr class="even">
<td>L1 miss</td>
<td>40 cycles</td>
</tr>
<tr class="odd">
<td>L2 miss</td>
<td>&gt;600 cycles</td>
</tr>
</tbody>
</table>
<h2 id="a-performance-checklist">A performance checklist</h2>
<ol class="incremental" style="list-style-type: decimal">
<li>compile with rtsopts flag</li>
</ol>
<pre><code>stack ghc -- --make examples/examples.hs -rtsopts -fforce-recomp</code></pre>
<ol class="incremental" start="2" style="list-style-type: decimal">
<li><p>check GC <code>examples/examples +RTS -s</code></p></li>
<li><p>enabling profiling</p></li>
</ol>
<ul class="incremental">
<li>a normal ghc: <code>stack ghc -- --make examples/examples.hs -rtsopts -fforce-recomp</code></li>
<li>profile enabled automatically: <code>stack ghc -- --make examples/examples.hs -rtsopts -fforce-recomp -prof -auto -auto-all</code></li>
<li>if template haskell: <code>stack ghc -- --make examples/examples.hs -rtsopts -fforce-recomp -prof -auto -auto-all -osuf p_o</code></li>
</ul>
<ol class="incremental" start="4" style="list-style-type: decimal">
<li><p>create an examples.prof on execution: <code>time examples/examples +RTS -p</code></p></li>
<li><p>space</p></li>
</ol>
<pre><code>examples/examples +RTS -p -hc
hp2ps -e8in -c examples/examples.hp
hp2ps -e8in -c examples/examples.hy # types
hp2ps -e8in -c examples/examples.hp # constructors</code></pre>
<ol class="incremental" start="6" style="list-style-type: decimal">
<li><p>check strictness pragmas</p></li>
<li><p>space leaks</p></li>
</ol>
<pre><code>examples/examples +RTS -s - additional memory
examples/examples +RTS -xt -hy</code></pre>
<hr />
<div class="footer">
<p>Made with love 'n' care; and <a href="https://haskell-lang.org/">haskell</a>, <a href="https://pandoc.org">pandoc</a>, and <a href="https://docs.haskellstack.org/en/stable/README/">stack</a>.</p>
</div>
